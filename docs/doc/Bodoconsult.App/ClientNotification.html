<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Client notifications | Bodoconsult.AppInfrastructure </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Client notifications | Bodoconsult.AppInfrastructure ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/Bodoconsult/Bodoconsult.AppInfrastructure/blob/main/doc/Bodoconsult.App/ClientNotification.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../logo.svg" alt="Bodoconsult.AppInfrastructure">
            Bodoconsult.AppInfrastructure
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="client-notifications">Client notifications</h1>

<p>In a client server environment the server (or the client) may send notifications to the client (or server). The notifications are transported via GRPC, REST or any other transport layer technology.</p>
<p>The client notifications system implemented in Bodoconsult.App is working one way. A client intended to receive notifications from the server has to login at the server. The login is handled by the IClientManager instance (normally a ClientManager instance). The IClientManager instance handles all clients and is responsible to forward the notifications created by the server to the clients logged in and intended to receive the notification.</p>
<p>If you need bidirectional notifications you can implement the client notifications system on both sides the server and the client.</p>
<h2 id="implement-your-notifcations-based-on-iclientnotification-as-required">Implement your notifcations based on IClientNotification as required</h2>
<p>Here a simple sample notification:</p>
<pre><code class="lang-csharp">/// &lt;summary&gt;
/// Test notification
/// &lt;/summary&gt;
public class TestNotification : IClientNotification
{
    /// &lt;summary&gt;
    /// Any message to transfer to the client
    /// &lt;/summary&gt;
    public string Message { get; set; }

    public object NotificationObjectToSend { get; set; }
}
</code></pre>
<h2 id="implement-an-iclientnotificationlicensemanager-instance">Implement an IClientNotificationLicenseManager instance</h2>
<p>Purpose of the IClientNotificationLicenseManager instance is to check if a certain type of client has permission to access client notifications.</p>
<p>Implement your own IClientNotificationLicenseManager implementation or use DummyClientNotificationLicenseManager if no license check is required.</p>
<h2 id="implement-an-iclientmessagingservice-instance">Implement an IClientMessagingService instance</h2>
<p>The ClientMessagingService instance is intended to convert the internal notification object to the data transfer object used to sent the notification content via the transportation layer to the client.</p>
<pre><code class="lang-csharp">/// &lt;summary&gt;
/// Sample implementation of &lt;see cref=&quot;IClientMessagingService&quot;/&gt;
/// &lt;/summary&gt;
public class FakeClientMessagingService : IClientMessagingService
{

    /// &lt;summary&gt;
    /// Default ctor: should load all required conversion rules
    /// &lt;/summary&gt;
    public FakeClientMessagingService()
    {
        ConversionRules.Add(nameof(TestNotification), ConvertToTestTransportLayerObject);
    }

    /// &lt;summary&gt;
    /// Converts a &lt;see cref=&quot;TestNotification&quot;/&gt; to a &lt;see cref=&quot;TestTransportLayerObject&quot;/&gt;
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;notification&quot;&gt;Notifications&lt;/param&gt;
    /// &lt;returns&gt;A &lt;see cref=&quot;TestTransportLayerObject&quot;/&gt; instance&lt;/returns&gt;
    /// &lt;remarks&gt;Method should be public for unit testing&lt;/remarks&gt;
    /// &lt;exception cref=&quot;ArgumentException&quot;&gt;Throws if the type of notification is not &lt;see cref=&quot;TestNotification&quot;/&gt;&lt;/exception&gt;
    public object ConvertToTestTransportLayerObject(IClientNotification notification)
    {
        if (notification is not TestNotification testNotification)
        {
            throw new ArgumentException(&quot;Wrong type of exeception. TestNotification is expected.&quot;);
        }

        return new TestTransportLayerObject
        {
            Message = testNotification.Message
        };
    }

    /// &lt;summary&gt;
    /// All conversion rules for notifications event args to client transport level target object
    /// &lt;/summary&gt;
    public Dictionary&lt;string, NotificationToTargetTransferObjectDelegate&gt; ConversionRules { get; } = new();


    /// &lt;summary&gt;
    /// Convert a notification into a client transport level target object
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;notification&quot;&gt;Current notification to send&lt;/param&gt;
    /// &lt;returns&gt;Object to transfer to the client on transport level&lt;/returns&gt;
    public object Convert(IClientNotification notification)
    {
        var typeName = notification.GetType().Name;

        var success = ConversionRules.TryGetValue(typeName, out var result);

        if (!success)
        {
            throw new ArgumentException($&quot;Type not found: {typeName}&quot;);
        }

        return result(notification);
    }
}
</code></pre>
<h2 id="setup-an-clientmanager-instance">Setup an ClientManager instance</h2>
<p>You can use ClientManager as default implementation of IClientManager or implement your own IClientManager implementation.</p>
<pre><code class="lang-csharp">[Test]
public void TestCtor()
{
    // Arrange 
    var licManager = TestHelper.GetFakeLicenceManager();
    var clientMessagingService = new FakeClientMessagingService();

    // Act  
    var cm = new ClientManager(licManager, _logger, clientMessagingService);

    // Assert
    Assert.That(cm.AllConnectedClients, Is.Not.Null);
    Assert.That(cm.AllConnectedClients.Count, Is.EqualTo(0));

}
</code></pre>
<h2 id="login-as-client">Login as client</h2>
<p>Now a client has to login to the IClientManager instance. Your client implementation must contain a transport layer connection to the client for sending the notification via this connection.</p>
<p>Client implementations can allow no, all or only certain notfications to be sent to the client represented by this implementations. Add all (or none) names of the internal notification implementations to the IClient.AllowedNotifications property.</p>
<pre><code class="lang-csharp">[Test]
public void TestAddClientFull()
{
    // Arrange 
    var licManager = TestHelper.GetFakeLicenceManager();
    var clientMessagingService = new FakeClientMessagingService();
    var cm = new ClientManager(licManager, _logger, clientMessagingService);

    Assert.That(cm.AllConnectedClients, Is.Not.Null);
    Assert.That(cm.AllConnectedClients.Count, Is.EqualTo(0));

    var client = new FakeClient
    {
        ClientData = new FakeLoginData { Type = (int)MyClientTypeEnum.Full }
    };

    // Act  
    cm.AddClient(client);

    // Assert
    Assert.That(cm.AllConnectedClients.Count, Is.EqualTo(1));
}
</code></pre>
<p>Remark: IClientManager.AddClient does not check if the client is allowed to login. You have to implement your own authentification if needed before calling IClientManager.AddClient.</p>
<h2 id="send-a-notification-to-the-connected-clients">Send a notification to the connected client(s)</h2>
<p>Setup your ClientMessagingBusinessDelegate instance and use its DoNotifyClient() method to send a notification to the client.</p>
<pre><code class="lang-csharp">[Test]
public void TestDoNotifyClient()
{
    // Arrange 
    IClientMessagingService cms = new FakeClientMessagingService();

    var client = new FakeClient
    {
        ClientData = new FakeLoginData()
    };

    var licManager = TestHelper.GetFakeLicenceManager();
    var clientMessagingService = new FakeClientMessagingService();
    var clientManager = new ClientManager(licManager, _logger, clientMessagingService);
    clientManager.AddClient(client);

    var cmdb = new ClientMessagingBusinessDelegate(cms, clientManager);

    var notification = new TestNotification();

    // Act  
    cmdb.DoNotifyClient(notification);

    // Assert
    Assert.That(cmdb.HasNotifications, Is.True);
}
</code></pre>
<pre><code class="lang-csharp">
</code></pre>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/Bodoconsult/Bodoconsult.AppInfrastructure/blob/main/doc/Bodoconsult.App/ClientNotification.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
